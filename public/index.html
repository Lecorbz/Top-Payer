<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TOP PAYER</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="style.css" rel="stylesheet" />
</head>
<body>
  <h1>TOP PAYER</h1>
  <p class="subtitle">Pay to rank higher. On the last day of the month, top 1 gets refunded!</p>
  <p id="min-info">Minimum payment required: loading...</p>
  <form id="payment-form">
    <input type="text" id="name" placeholder="Your name" required />
    <input type="email" id="email" placeholder="Your email" required />
    <input type="number" id="amount" placeholder="Amount in €" min="1" step="1" required />
    <input type="url" id="link" placeholder="Website or social link (optional)" />
    <button type="submit">PAY</button>
  </form>
  <table>
    <thead>
      <tr><th>#</th><th>Player</th><th>€</th></tr>
    </thead>
    <tbody id="ranking-body"></tbody>
  </table>

  <script>
    const BACKEND_URL = "https://top-payer.onrender.com";

    async function getMinAmount() {
      const res = await fetch(`${BACKEND_URL}/api/min`);
      const data = await res.json();
      document.getElementById("min-info").innerText = "Minimum payment required: " + data.min + "€";
      document.getElementById("amount").setAttribute("min", data.min);
    }

    async function getRanking() {
      const res = await fetch(`${BACKEND_URL}/api/ranking`);
      const list = await res.json();
      const body = document.getElementById("ranking-body");
      body.innerHTML = "";
      list.forEach((entry, i) => {
        const medalClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        body.innerHTML += `<tr class="${medalClass}">
          <td>${i + 1}</td>
          <td>${entry.link ? `<a href="${entry.link}" target="_blank">${entry.name}</a>` : entry.name}</td>
          <td>${entry.amount}</td>
        </tr>`;
      });
    }

    document.getElementById("payment-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const amount = parseInt(document.getElementById("amount").value);
      const link = document.getElementById("link").value.trim();

      if (isNaN(amount) || amount < parseInt(document.getElementById("amount").min)) {
        alert("Amount must be at least " + document.getElementById("amount").min + "€");
        return;
      }

      const res = await fetch(`${BACKEND_URL}/api/checkout`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, amount, link })
      });

      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        alert(data.error || "Something went wrong.");
      }
    });

    getMinAmount();
    getRanking();
  </script>
</body>
</html>
